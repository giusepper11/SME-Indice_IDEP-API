language: python
env:
  - DOCKER_COMPOSE_VERSION=1.4.2

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - chmod +x merge_script.sh

script:
  - make tests

after_success:
  - |

    declare -r SSH_FILE="$(mktemp -u $HOME/.ssh/XXXXX)"

    # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

    # Decrypt the file containing the private key
    # (Note: this is the same as what is generated by the Travis CLI at step 2.5)

    openssl aes-256-cbc \
      -K $eencrypted_11da460eb7e8_key \
      -iv $encrypted_11da460eb7e8_iv \
      -in ".travis/github_deploy_key.enc" \
      -out "$SSH_FILE" -d

    # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

    # Enable SSH authentication

    chmod 600 "$SSH_FILE" \
      && printf "%s\n" \
           "Host github.com" \
           "  IdentityFile $SSH_FILE" \
           "  LogLevel ERROR" >> ~/.ssh/config
  - ./merge_script.sh